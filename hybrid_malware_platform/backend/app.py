# backend/app.py
import os
from pathlib import Path
from flask import Flask, render_template, request, redirect, url_for, flash
from config import UPLOAD_FOLDER, SECRET_KEY
from utils.file_utils import safe_save_upload
from utils.logging_utils import setup_logger

# ── Resolve absolute paths ──
BASE_DIR = Path(__file__).resolve().parents[1]   # .../hybrid_malware_platform
BACKEND_DIR   = BASE_DIR / "backend"
TEMPLATES_DIR = BASE_DIR / "frontend" / "templates"
STATIC_DIR    = BASE_DIR / "frontend" / "static"

# Normalize folders: if env path is relative, place it inside /backend
def to_backend_path(p: str) -> Path:
    pth = Path(p)
    return (BACKEND_DIR / pth) if not pth.is_absolute() else pth

UPLOAD_DIR = to_backend_path(UPLOAD_FOLDER)
REPORT_DIR = to_backend_path(os.getenv("REPORT_FOLDER", "reports"))

# ── Flask app ──
app = Flask(__name__, template_folder=str(TEMPLATES_DIR), static_folder=str(STATIC_DIR))
app.secret_key = SECRET_KEY

# Ensure required dirs exist
os.makedirs(UPLOAD_DIR, exist_ok=True)
os.makedirs(REPORT_DIR, exist_ok=True)
logs_dir = BACKEND_DIR / "logs"
os.makedirs(logs_dir, exist_ok=True)

log = setup_logger("app", str(logs_dir))

# ── Routes ──
@app.route("/", methods=["GET"])
def index():
    return render_template("index.html")

@app.route("/upload", methods=["POST"])
def upload():
    f = request.files.get("file")
    if not f:
        flash("No file provided", "error")
        return redirect(url_for("index"))
    try:
        info = safe_save_upload(f, str(UPLOAD_DIR))
        flash(f"Uploaded: {info['orig_name']} → SHA256:{info['sha256'][:12]}…", "success")
        log.info(f"Uploaded {info['orig_name']} sha256={info['sha256']} size={info['size']} mime={info['mime']}")
        return redirect(url_for("detail", sha256=info["sha256"]))
    except Exception as e:
        log.exception("Upload failed")
        flash(str(e), "error")
        return redirect(url_for("index"))

@app.route("/detail/<sha256>", methods=["GET"])
def detail(sha256: str):
    import json
    meta_path = UPLOAD_DIR / f"{sha256}.json"
    if not meta_path.exists():
        return "Not found", 404
    with open(meta_path, "r", encoding="utf-8") as f:
        meta = json.load(f)
    return render_template("analysis_result.html", meta=meta)

# ── Entrypoint ──
if __name__ == "__main__":
    app.run(host="127.0.0.1", port=5000, debug=False, threaded=True)
